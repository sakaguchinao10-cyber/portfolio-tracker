<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>資産ポートフォリオ管理</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // アイコン
    const Plus = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
      </svg>
    );

    const Trash2 = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
    );

    const RefreshCw = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
    );

    const TrendingUp = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
      </svg>
    );

    const TrendingDown = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" />
      </svg>
    );

    const Minus = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 12H4" />
      </svg>
    );

    const Edit = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
      </svg>
    );

    const Settings = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    );

    const storage = window.storage || {
      get: async (key) => {
        const data = localStorage.getItem(key);
        return data ? { key, value: data, shared: false } : null;
      },
      set: async (key, value) => {
        localStorage.setItem(key, value);
        return { key, value, shared: false };
      }
    };

    const AssetPortfolioTracker = () => {
      const [assets, setAssets] = useState([]);
      const [showAddForm, setShowAddForm] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [editingId, setEditingId] = useState(null);
      const [loading, setLoading] = useState(true);
      const [updating, setUpdating] = useState({});
      const [usdJpyRate, setUsdJpyRate] = useState(150);
      const [apiKey, setApiKey] = useState('');
      const [tempApiKey, setTempApiKey] = useState('');

      const assetTypes = [
        'FX(ドル円)',
        'FX(ユーロ円)',
        '米国株',
        '米国ETF',
        '日本株',
        '日本投資信託',
        '日本ETF',
        '金',
        '銀',
        'プラチナ',
        'Bitcoin',
        'Ethereum',
        'XRP'
      ];

      const [formData, setFormData] = useState({
        type: '日本株',
        ticker: '',
        name: '',
        acquisitionPrice: '',
        acquisitionPriceUsd: '',
        quantity: '',
        currentPrice: '',
        currentPriceUsd: '',
        previousDayPrice: '',
        previousMonthPrice: '',
        goldenCross: false,
        kabutanUrl: '',
        isHolding: true
      });

      useEffect(() => {
        loadAssets();
        loadApiKey();
        fetchUsdJpyRate();
      }, []);

      const loadApiKey = async () => {
        try {
          const result = await storage.get('alpha-vantage-api-key');
          if (result && result.value) {
            setApiKey(result.value);
            setTempApiKey(result.value);
          }
        } catch (error) {
          console.log('APIキー未設定');
        }
      };

      const saveApiKey = async () => {
        try {
          await storage.set('alpha-vantage-api-key', tempApiKey);
          setApiKey(tempApiKey);
          setShowSettings(false);
          alert('APIキーを保存しました');
        } catch (error) {
          alert('APIキーの保存に失敗しました');
        }
      };

      const loadAssets = async () => {
        try {
          const result = await storage.get('portfolio-assets');
          if (result && result.value) {
            setAssets(JSON.parse(result.value));
          }
        } catch (error) {
          console.log('初回起動');
        } finally {
          setLoading(false);
        }
      };

      const fetchUsdJpyRate = async () => {
        try {
          const response = await fetch('https://api.frankfurter.app/latest?from=USD&to=JPY');
          const data = await response.json();
          if (data.rates && data.rates.JPY) {
            setUsdJpyRate(data.rates.JPY);
          }
        } catch (error) {
          console.log('為替レート取得失敗');
        }
      };

      const generateKabutanUrl = (ticker, type) => {
        if (type === '日本株' || type === '日本ETF' || type === '日本投資信託') {
          return `https://kabutan.jp/stock/?code=${ticker}`;
        } else if (type === '米国株' || type === '米国ETF') {
          return `https://kabutan.jp/stock/chart?code=${ticker}.us`;
        } else if (type === 'FX(ドル円)') {
          return 'https://kabutan.jp/stock/chart?code=998407';
        } else if (type === 'FX(ユーロ円)') {
          return 'https://kabutan.jp/stock/chart?code=998405';
        } else if (type === '金') {
          return 'https://kabutan.jp/stock/chart?code=1540';
        } else if (type === '銀') {
          return 'https://kabutan.jp/stock/chart?code=1542';
        } else if (type === 'プラチナ') {
          return 'https://kabutan.jp/stock/chart?code=1541';
        } else if (type === 'Bitcoin') {
          return 'https://finance.yahoo.com/quote/BTC-USD';
        } else if (type === 'Ethereum') {
          return 'https://finance.yahoo.com/quote/ETH-USD';
        } else if (type === 'XRP') {
          return 'https://finance.yahoo.com/quote/XRP-USD';
        }
        return '';
      };

      const getYahooSymbol = (asset) => {
        if (asset.type === '日本株' || asset.type === '日本ETF') {
          return `${asset.ticker}.T`;
        } else if (asset.type === 'FX(ドル円)') {
          return 'USDJPY=X';
        } else if (asset.type === 'FX(ユーロ円)') {
          return 'EURJPY=X';
        } else if (asset.type === '金') {
          return 'GC=F';
        } else if (asset.type === '銀') {
          return 'SI=F';
        } else if (asset.type === 'プラチナ') {
          return 'PL=F';
        } else if (asset.type === 'Bitcoin') {
          return 'BTC-USD';
        } else if (asset.type === 'Ethereum') {
          return 'ETH-USD';
        } else if (asset.type === 'XRP') {
          return 'XRP-USD';
        }
        return asset.ticker;
      };

      const fetchYahooFinance = async (symbol) => {
        try {
          const url = `https://query2.finance.yahoo.com/v8/finance/chart/${symbol}?range=1mo&interval=1d`;
          const response = await fetch(url);
          const data = await response.json();
          
          if (data.chart && data.chart.result && data.chart.result[0]) {
            const result = data.chart.result[0];
            const quotes = result.indicators.quote[0];
            const timestamps = result.timestamp;
            
            if (quotes.close && quotes.close.length > 0) {
              const closes = quotes.close.filter(p => p !== null);
              const currentPrice = closes[closes.length - 1];
              const previousDayPrice = closes.length > 1 ? closes[closes.length - 2] : currentPrice;
              const previousMonthPrice = closes.length > 20 ? closes[closes.length - 21] : closes[0];
              
              return {
                currentPrice,
                previousDayPrice,
                previousMonthPrice
              };
            }
          }
          return null;
        } catch (error) {
          console.error('Yahoo Finance取得エラー:', error);
          return null;
        }
      };

      const updatePriceWithYahoo = async (asset) => {
        setUpdating(prev => ({ ...prev, [asset.id]: true }));
        
        try {
          const symbol = getYahooSymbol(asset);
          const priceData = await fetchYahooFinance(symbol);
          
          if (!priceData) {
            alert('価格の取得に失敗しました');
            return;
          }

          let currentPrice = priceData.currentPrice;
          let currentPriceUsd = 0;

          // 金銀プラチナはトロイオンスからグラムあたり円に変換
          if (asset.type === '金' || asset.type === '銀' || asset.type === 'プラチナ') {
            const troyOunceToGram = 31.1035;
            currentPrice = (priceData.currentPrice * usdJpyRate) / troyOunceToGram;
          }
          // 暗号通貨は円換算
          else if (asset.type === 'Bitcoin' || asset.type === 'Ethereum' || asset.type === 'XRP') {
            currentPriceUsd = priceData.currentPrice;
            currentPrice = priceData.currentPrice * usdJpyRate;
          }

          const updatedAsset = {
            ...asset,
            currentPrice: currentPrice,
            currentPriceUsd: currentPriceUsd,
            previousDayPrice: asset.type === '金' || asset.type === '銀' || asset.type === 'プラチナ' 
              ? (priceData.previousDayPrice * usdJpyRate) / 31.1035
              : priceData.previousDayPrice,
            previousMonthPrice: asset.type === '金' || asset.type === '銀' || asset.type === 'プラチナ'
              ? (priceData.previousMonthPrice * usdJpyRate) / 31.1035
              : priceData.previousMonthPrice
          };

          const updatedAssets = assets.map(a => a.id === asset.id ? updatedAsset : a);
          await saveAssets(updatedAssets);
          
          alert('価格を更新しました');
        } catch (error) {
          console.error('価格更新エラー:', error);
          alert('価格の更新に失敗しました');
        } finally {
          setUpdating(prev => ({ ...prev, [asset.id]: false }));
        }
      };

      const updatePriceWithAlphaVantage = async (asset) => {
        if (!apiKey) {
          alert('APIキーが設定されていません');
          return;
        }

        setUpdating(prev => ({ ...prev, [asset.id]: true }));

        try {
          const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${asset.ticker}&apikey=${apiKey}`;
          const response = await fetch(url);
          const data = await response.json();
          
          if (data['Global Quote'] && data['Global Quote']['05. price']) {
            const currentPriceUsd = parseFloat(data['Global Quote']['05. price']);
            const currentPrice = currentPriceUsd * usdJpyRate;

            const updatedAsset = {
              ...asset,
              previousDayPrice: asset.currentPrice,
              currentPrice: currentPrice,
              currentPriceUsd: currentPriceUsd
            };

            const updatedAssets = assets.map(a => a.id === asset.id ? updatedAsset : a);
            await saveAssets(updatedAssets);
            
            alert('価格を更新しました');
          } else if (data['Note']) {
            alert('API制限に達しました。1分待ってから再試行してください。');
          }
        } catch (error) {
          console.error('価格更新エラー:', error);
          alert('価格の更新に失敗しました');
        } finally {
          setUpdating(prev => ({ ...prev, [asset.id]: false }));
        }
      };

      const updatePrice = async (asset) => {
        // 米国株・ETFはAlpha Vantage
        if (asset.type === '米国株' || asset.type === '米国ETF') {
          await updatePriceWithAlphaVantage(asset);
        }
        // その他はYahoo Finance
        else {
          await updatePriceWithYahoo(asset);
        }
      };

      const updateAllPrices = async () => {
        for (const asset of assets) {
          await updatePrice(asset);
          await new Promise(resolve => setTimeout(resolve, 3000));
        }
      };

      const saveAssets = async (updatedAssets) => {
        try {
          await storage.set('portfolio-assets', JSON.stringify(updatedAssets));
          setAssets(updatedAssets);
        } catch (error) {
          console.error('保存エラー:', error);
          alert('データの保存に失敗しました');
        }
      };

      const handleSubmit = () => {
        if (!formData.ticker || !formData.name) {
          alert('ティッカー/コードと銘柄名は必須です');
          return;
        }

        const kabutanUrl = formData.kabutanUrl || generateKabutanUrl(formData.ticker, formData.type);

        const asset = {
          ...formData,
          id: editingId || Date.now(),
          acquisitionPrice: parseFloat(formData.acquisitionPrice) || 0,
          acquisitionPriceUsd: parseFloat(formData.acquisitionPriceUsd) || 0,
          quantity: parseFloat(formData.quantity) || 0,
          currentPrice: parseFloat(formData.currentPrice) || 0,
          currentPriceUsd: parseFloat(formData.currentPriceUsd) || 0,
          previousDayPrice: parseFloat(formData.previousDayPrice) || 0,
          previousMonthPrice: parseFloat(formData.previousMonthPrice) || 0,
          kabutanUrl
        };

        let updatedAssets;
        if (editingId) {
          updatedAssets = assets.map(a => a.id === editingId ? asset : a);
        } else {
          updatedAssets = [...assets, asset];
        }
        
        saveAssets(updatedAssets);
        resetForm();
      };

      const startEdit = (asset) => {
        setEditingId(asset.id);
        setFormData({
          type: asset.type,
          ticker: asset.ticker,
          name: asset.name,
          acquisitionPrice: asset.acquisitionPrice.toString(),
          acquisitionPriceUsd: asset.acquisitionPriceUsd.toString(),
          quantity: asset.quantity.toString(),
          currentPrice: asset.currentPrice.toString(),
          currentPriceUsd: asset.currentPriceUsd.toString(),
          previousDayPrice: asset.previousDayPrice.toString(),
          previousMonthPrice: asset.previousMonthPrice.toString(),
          goldenCross: asset.goldenCross,
          kabutanUrl: asset.kabutanUrl,
          isHolding: asset.isHolding
        });
        setShowAddForm(true);
      };

      const resetForm = () => {
        setFormData({
          type: '日本株',
          ticker: '',
          name: '',
          acquisitionPrice: '',
          acquisitionPriceUsd: '',
          quantity: '',
          currentPrice: '',
          currentPriceUsd: '',
          previousDayPrice: '',
          previousMonthPrice: '',
          goldenCross: false,
          kabutanUrl: '',
          isHolding: true
        });
        setEditingId(null);
        setShowAddForm(false);
      };

      const deleteAsset = (id) => {
        if (confirm('この銘柄を削除しますか?')) {
          const updatedAssets = assets.filter(a => a.id !== id);
          saveAssets(updatedAssets);
        }
      };

      const toggleGoldenCross = (id) => {
        const updatedAssets = assets.map(a =>
          a.id === id ? { ...a, goldenCross: !a.goldenCross } : a
        );
        saveAssets(updatedAssets);
      };

      const isUsAsset = (type) => {
        return type === '米国株' || type === '米国ETF';
      };

      const isCryptoAsset = (type) => {
        return type === 'Bitcoin' || type === 'Ethereum' || type === 'XRP';
      };

      const isPreciousMetal = (type) => {
        return type === '金' || type === '銀' || type === 'プラチナ';
      };

      const calculateMetrics = (asset) => {
        const isUs = isUsAsset(asset.type);
        const isCrypto = isCryptoAsset(asset.type);
        
        const dayDiff = asset.currentPrice - asset.previousDayPrice;
        const dayDiffRate = asset.previousDayPrice ? (dayDiff / asset.previousDayPrice * 100) : 0;
        
        const monthDiff = asset.currentPrice - asset.previousMonthPrice;
        const monthDiffRate = asset.previousMonthPrice ? (monthDiff / asset.previousMonthPrice * 100) : 0;
        
        const marketValueUsd = (isUs || isCrypto) ? asset.currentPriceUsd * asset.quantity : 0;
        const marketValueJpy = (isUs || isCrypto) ? marketValueUsd * usdJpyRate : asset.currentPrice * asset.quantity;
        
        const acquisitionValueUsd = (isUs || isCrypto) ? asset.acquisitionPriceUsd * asset.quantity : 0;
        const acquisitionValueJpy = (isUs || isCrypto) ? acquisitionValueUsd * usdJpyRate : asset.acquisitionPrice * asset.quantity;
        
        const gainLossUsd = marketValueUsd - acquisitionValueUsd;
        const gainLossJpy = marketValueJpy - acquisitionValueJpy;
        const gainLossRate = acquisitionValueJpy ? (gainLossJpy / acquisitionValueJpy * 100) : 0;
        
        let trend = dayDiff > 0 ? 'up' : dayDiff < 0 ? 'down' : 'neutral';
        
        return {
          dayDiff, dayDiffRate, monthDiff, monthDiffRate,
          marketValueUsd, marketValueJpy,
          acquisitionValueUsd, acquisitionValueJpy,
          gainLossUsd, gainLossJpy, gainLossRate, trend
        };
      };

      const formatNumber = (num, decimals = 2) => {
        return num.toLocaleString('ja-JP', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
      };

      const formatCurrency = (num, currency = 'JPY', type = '') => {
        if (currency === 'USD') {
          return `$${formatNumber(num)}`;
        }
        if (isPreciousMetal(type)) {
          return `¥${formatNumber(num, 0)}/g`;
        }
        return `¥${formatNumber(num, 0)}`;
      };

      const TrendIcon = ({ trend }) => {
        if (trend === 'up') return <TrendingUp className="w-4 h-4 text-green-600" />;
        if (trend === 'down') return <TrendingDown className="w-4 h-4 text-red-600" />;
        return <Minus className="w-4 h-4 text-gray-400" />;
      };

      if (loading) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <RefreshCw className="w-8 h-8 animate-spin text-blue-600 mx-auto mb-2" />
              <p className="text-gray-600">読み込み中...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50 p-2 sm:p-4">
          <div className="max-w-7xl mx-auto">
            <div className="bg-white rounded-lg shadow-sm p-4 mb-4">
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                  <h1 className="text-2xl font-bold text-gray-900">資産ポートフォリオ</h1>
                  <p className="text-sm text-gray-500 mt-1">株式・FX・暗号通貨・貴金属の管理</p>
                </div>
                <div className="flex gap-2 w-full sm:w-auto flex-wrap">
                  <input
                    type="number"
                    value={usdJpyRate}
                    onChange={(e) => setUsdJpyRate(parseFloat(e.target.value) || 150)}
                    className="px-3 py-2 border rounded-lg text-sm w-24"
                    placeholder="USD/JPY"
                  />
                  <button
                    onClick={() => setShowSettings(true)}
                    className="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 flex items-center gap-2"
                  >
                    <Settings className="w-4 h-4" />
                  </button>
                  <button
                    onClick={updateAllPrices}
                    className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2"
                  >
                    <RefreshCw className="w-4 h-4" />
                    <span>全更新</span>
                  </button>
                  <button
                    onClick={() => { resetForm(); setShowAddForm(!showAddForm); }}
                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2"
                  >
                    <Plus className="w-4 h-4" />
                    <span>銘柄追加</span>
                  </button>
                </div>
              </div>
            </div>

            {showSettings && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-lg shadow-xl p-6 max-w-md w-full">
                  <h2 className="text-xl font-bold mb-4">API設定</h2>
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Alpha Vantage APIキー（米国株用）
                    </label>
                    <input
                      type="text"
                      value={tempApiKey}
                      onChange={(e) => setTempApiKey(e.target.value)}
                      className="w-full px-3 py-2 border rounded-lg"
                      placeholder="APIキーを入力"
                    />
                    <p className="text-xs text-gray-500 mt-2">
                      <a href="https://www.alphavantage.co/" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">Alpha Vantage</a> で無料取得
                    </p>
                  </div>
                  <div className="bg-blue-50 p-3 rounded-lg mb-4">
                    <p className="text-xs text-gray-700">
                      ℹ️ 日本株・FX・暗号通貨・貴金属はYahoo Financeから自動取得されます（APIキー不要）
                    </p>
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={saveApiKey}
                      className="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                    >
                      保存
                    </button>
                    <button
                      onClick={() => setShowSettings(false)}
                      className="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300"
                    >
                      キャンセル
                    </button>
                  </div>
                </div>
              </div>
            )}

            {showAddForm && (
              <div className="bg-white rounded-lg shadow-sm p-4 mb-4">
                <h2 className="text-lg font-semibold mb-4">{editingId ? '銘柄編集' : '新規銘柄追加'}</h2>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">資産種類</label>
                    <select
                      value={formData.type}
                      onChange={(e) => setFormData({ ...formData, type: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg"
                    >
                      {assetTypes.map(type => (
                        <option key={type} value={type}>{type}</option>
                      ))}
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {isPreciousMetal(formData.type) || isCryptoAsset(formData.type) ? 'シンボル（自動設定）' : 'ティッカー/コード'}
                    </label>
                    <input
                      type="text"
                      value={formData.ticker}
                      onChange={(e) => setFormData({ ...formData, ticker: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg"
                      placeholder={isPreciousMetal(formData.type) || isCryptoAsset(formData.type) ? '自動設定' : 'AAPL, 7203など'}
                      disabled={isPreciousMetal(formData.type) || isCryptoAsset(formData.type)}
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">銘柄名</label>
                    <input
                      type="text"
                      value={formData.name}
                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      取得単価{(isUsAsset(formData.type) || isCryptoAsset(formData.type)) ? ' (USD)' : isPreciousMetal(formData.type) ? ' (円/g)' : ' (円)'}
                    </label>
                    <input
                      type="number"
                      value={(isUsAsset(formData.type) || isCryptoAsset(formData.type)) ? formData.acquisitionPriceUsd : formData.acquisitionPrice}
                      onChange={(e) => setFormData({
                        ...formData,
                        ...((isUsAsset(formData.type) || isCryptoAsset(formData.type))
                          ? { acquisitionPriceUsd: e.target.value }
                          : { acquisitionPrice: e.target.value })
                      })}
                      className="w-full px-3 py-2 border rounded-lg"
                      step="0.01"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      保有数量{isPreciousMetal(formData.type) ? ' (g)' : ''}
                    </label>
                    <input
                      type="number"
                      value={formData.quantity}
                      onChange={(e) => setFormData({ ...formData, quantity: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg"
                      step="0.01"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      現在価格{(isUsAsset(formData.type) || isCryptoAsset(formData.type)) ? ' (USD)' : isPreciousMetal(formData.type) ? ' (円/g)' : ' (円)'}
                    </label>
                    <input
                      type="number"
                      value={(isUsAsset(formData.type) || isCryptoAsset(formData.type)) ? formData.currentPriceUsd : formData.currentPrice}
                      onChange={(e) => setFormData({
                        ...formData,
                        ...((isUsAsset(formData.type) || isCryptoAsset(formData.type))
                          ? { currentPriceUsd: e.target.value, currentPrice: parseFloat(e.target.value) * usdJpyRate }
                          : { currentPrice: e.target.value })
                      })}
                      className="w-full px-3 py-2 border rounded-lg"
                      step="0.01"
                    />
                  </div>

                  <div className="flex items-end">
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={formData.isHolding}
                        onChange={(e) => setFormData({ ...formData, isHolding: e.target.checked })}
                        className="w-4 h-4"
                      />
                      <span className="text-sm font-medium text-gray-700">保有中</span>
                    </label>
                  </div>
                </div>

                <div className="flex gap-2 mt-4">
                  <button
                    onClick={handleSubmit}
                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                  >
                    {editingId ? '更新' : '追加'}
                  </button>
                  <button
                    onClick={resetForm}
                    className="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300"
                  >
                    キャンセル
                  </button>
                </div>
              </div>
            )}

            <div className="bg-white rounded-lg shadow-sm overflow-hidden">
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className="bg-gray-50 border-b">
                    <tr>
                      <th className="px-3 py-3 text-left font-semibold text-gray-700">種類</th>
                      <th className="px-3 py-3 text-left font-semibold text-gray-700">銘柄名</th>
                      <th className="px-3 py-3 text-right font-semibold text-gray-700">前日比</th>
                      <th className="px-3 py-3 text-right font-semibold text-gray-700">前月比</th>
                      <th className="px-3 py-3 text-right font-semibold text-gray-700">時価</th>
                      <th className="px-3 py-3 text-right font-semibold text-gray-700">損益</th>
                      <th className="px-3 py-3 text-center font-semibold text-gray-700">GC</th>
                      <th className="px-3 py-3 text-center font-semibold text-gray-700">傾向</th>
                      <th className="px-3 py-3 text-center font-semibold text-gray-700">操作</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y">
                    {assets.length === 0 ? (
                      <tr>
                        <td colSpan="9" className="px-3 py-8 text-center text-gray-500">
                          銘柄が登録されていません
                        </td>
                      </tr>
                    ) : (
                      assets.map((asset) => {
                        const metrics = calculateMetrics(asset);
                        const isUs = isUsAsset(asset.type);
                        const isCrypto = isCryptoAsset(asset.type);
                        const isMetal = isPreciousMetal(asset.type);
                        
                        return (
                          <tr key={asset.id} className={`hover:bg-gray-50 ${!asset.isHolding ? 'bg-blue-50' : ''}`}>
                            <td className="px-3 py-3">
                              <div className="flex items-center gap-1">
                                <span className="text-xs px-2 py-1 bg-gray-100 rounded">{asset.type}</span>
                                {!asset.isHolding && (
                                  <span className="text-xs px-1 py-1 bg-blue-100 text-blue-700 rounded">監視</span>
                                )}
                              </div>
                            </td>
                            <td className="px-3 py-3">
                              {asset.kabutanUrl ? (
                                <a href={asset.kabutanUrl} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">
                                  {asset.name}
                                </a>
                              ) : (
                                asset.name
                              )}
                            </td>
                            <td className="px-3 py-3 text-right">
                              <div className={metrics.dayDiff >= 0 ? 'text-green-600' : 'text-red-600'}>
                                <div className="font-semibold">{metrics.dayDiff >= 0 ? '+' : ''}{formatNumber(metrics.dayDiff)}</div>
                                <div className="text-xs">({metrics.dayDiffRate >= 0 ? '+' : ''}{formatNumber(metrics.dayDiffRate)}%)</div>
                              </div>
                            </td>
                            <td className="px-3 py-3 text-right">
                              <div className={metrics.monthDiff >= 0 ? 'text-green-600' : 'text-red-600'}>
                                <div className="font-semibold">{metrics.monthDiff >= 0 ? '+' : ''}{formatNumber(metrics.monthDiff)}</div>
                                <div className="text-xs">({metrics.monthDiffRate >= 0 ? '+' : ''}{formatNumber(metrics.monthDiffRate)}%)</div>
                              </div>
                            </td>
                            <td className="px-3 py-3 text-right">
                              {(isUs || isCrypto) ? (
                                <>
                                  <div className="font-semibold">{formatCurrency(metrics.marketValueUsd, 'USD')}</div>
                                  <div className="text-xs text-gray-500">{formatCurrency(metrics.marketValueJpy)}</div>
                                </>
                              ) : (
                                <div className="font-semibold">{formatCurrency(metrics.marketValueJpy, 'JPY', asset.type)}</div>
                              )}
                            </td>
                            <td className="px-3 py-3 text-right">
                              <div className={metrics.gainLossJpy >= 0 ? 'text-green-600' : 'text-red-600'}>
                                {(isUs || isCrypto) && (
                                  <div className="font-semibold">{metrics.gainLossUsd >= 0 ? '+' : ''}{formatCurrency(metrics.gainLossUsd, 'USD')}</div>
                                )}
                                <div className={(isUs || isCrypto) ? 'text-xs' : 'font-semibold'}>{metrics.gainLossJpy >= 0 ? '+' : ''}{formatCurrency(metrics.gainLossJpy)}</div>
                                <div className="text-xs">({metrics.gainLossRate >= 0 ? '+' : ''}{formatNumber(metrics.gainLossRate)}%)</div>
                              </div>
                            </td>
                            <td className="px-3 py-3 text-center">
                              <button
                                onClick={() => toggleGoldenCross(asset.id)}
                                className={`px-2 py-1 rounded text-xs font-semibold ${
                                  asset.goldenCross ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-400'
                                }`}
                              >
                                {asset.goldenCross ? 'GC' : '-'}
                              </button>
                            </td>
                            <td className="px-3 py-3 text-center">
                              <div className="flex justify-center">
                                <TrendIcon trend={metrics.trend} />
                              </div>
                            </td>
                            <td className="px-3 py-3">
                              <div className="flex justify-center gap-1">
                                <button
                                  onClick={() => updatePrice(asset)}
                                  disabled={updating[asset.id]}
                                  className="text-blue-600 hover:text-blue-800 p-1 disabled:opacity-50"
                                >
                                  <RefreshCw className={`w-4 h-4 ${updating[asset.id] ? 'animate-spin' : ''}`} />
                                </button>
                                <button
                                  onClick={() => startEdit(asset)}
                                  className="text-green-600 hover:text-green-800 p-1"
                                >
                                  <Edit className="w-4 h-4" />
                                </button>
                                <button
                                  onClick={() => deleteAsset(asset.id)}
                                  className="text-red-600 hover:text-red-800 p-1"
                                >
                                  <Trash2 className="w-4 h-4" />
                                </button>
                              </div>
                            </td>
                          </tr>
                        );
                      })
                    )}
                  </tbody>
                </table>
              </div>
            </div>

            {assets.length > 0 && (
              <div className="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <div className="text-sm text-gray-600">総資産（保有）</div>
                  <div className="text-2xl font-bold text-gray-900 mt-1">
                    {formatCurrency(
                      assets.filter(a => a.isHolding).reduce((sum, a) => sum + calculateMetrics(a).marketValueJpy, 0)
                    )}
                  </div>
                </div>
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <div className="text-sm text-gray-600">総損益</div>
                  <div className={`text-2xl font-bold mt-1 ${
                    assets.filter(a => a.isHolding).reduce((sum, a) => sum + calculateMetrics(a).gainLossJpy, 0) >= 0
                      ? 'text-green-600' : 'text-red-600'
                  }`}>
                    {formatCurrency(
                      assets.filter(a => a.isHolding).reduce((sum, a) => sum + calculateMetrics(a).gainLossJpy, 0)
                    )}
                  </div>
                </div>
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <div className="text-sm text-gray-600">登録銘柄数</div>
                  <div className="text-2xl font-bold text-gray-900 mt-1">
                    {assets.filter(a => a.isHolding).length} / {assets.length}
                    <span className="text-sm text-gray-500 ml-1">件</span>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    ReactDOM.render(<AssetPortfolioTracker />, document.getElementById('root'));
  </script>
</body>
</html>